dbType: postgres
supportedVersions:
  min: "15.0.0.0.0"
  max: "18.99.99.99.99"
description: Swiss sampler queries for PostgreSQL 15
collectors:
  swiss:
    description: Swiss sampler query set
    queries:
      sqltext:
        description: Get SQL text by query ID
        sql: |
          SELECT queryid::text AS sql_id, query AS sql_text, query AS sql_fulltext
          FROM pg_stat_statements
          WHERE queryid = CAST(:sql_id AS bigint)
          LIMIT 1
        singleRow: true
        parameters:
          - sql_id
      sqlplan:
        description: Get execution plan by query ID (using EXPLAIN)
        sql: |
          EXPLAIN (FORMAT TEXT, ANALYZE FALSE) 
          SELECT queryid::text AS sql_id, query AS sql_text
          FROM pg_stat_statements
          WHERE queryid = CAST(:sql_id AS bigint)
          LIMIT 1
        singleRow: false
        parameters:
          - sql_id
      active_transactions:
        description: Active transactions
        sql: |
          SELECT 
            backend_xid AS "xid", 
            pid AS "sid", 
            NULL::bigint AS "serial#", 
            usename AS "username", 
            xact_start AS "start_time" 
          FROM pg_stat_activity 
          WHERE xact_start IS NOT NULL 
          ORDER BY xact_start
        singleRow: false
      locks:
        description: Current locks
        sql: |
          SELECT 
                 l.pid AS "sid", 
                 NULL::bigint AS "serial#", 
                 a.usename AS "username", 
                 l.mode AS "locked_mode", 
                 COALESCE(CASE WHEN l.relation IS NOT NULL THEN 'relation' ELSE l.locktype END, 'unknown') AS "object_type", 
                 COALESCE(c.relname, l.locktype) AS "object_name" 
          FROM pg_locks l 
          LEFT JOIN pg_class c ON l.relation = c.oid 
          LEFT JOIN pg_stat_activity a ON l.pid = a.pid 
          ORDER BY l.mode DESC
        singleRow: false
      tablespaces:
        description: Tablespace usage
        sql: |
          SELECT 
                 spcname AS tablespace_name, 
                 ROUND(pg_tablespace_size(oid)::numeric / 1024 / 1024 / 1024, 2) "size_gb"
          FROM pg_tablespace
        singleRow: false
      sga_allocation:
        description: SGA pool allocation
        sql: |
          SELECT 
            ROUND(pg_size_bytes(current_setting('shared_buffers'))/1024/1024, 2) "shared_pool_mb"
        singleRow: true
      cache_hit_ratio:
        description: Buffer cache hit ratio
        sql: |
          SELECT 
            ROUND(100 * SUM(blks_hit) / NULLIF(SUM(blks_hit) + SUM(blks_read), 0), 2) "hit_ratio_pct",
            SUM(blks_read) "physical_reads",
            SUM(blks_hit) + SUM(blks_read) AS "logical_reads"
          FROM pg_stat_database
        singleRow: true
      long_running_sessions:
        description: Sessions running for extended duration
        sql: |
          SELECT 
            pid AS "sid",
            NULL::bigint AS "serial#",
            usename AS "username",
            state AS "status",
            ROUND(EXTRACT(EPOCH FROM (now() - COALESCE(query_start, backend_start))) / 60, 0) "duration_min",
            COALESCE(wait_event, 'ON CPU') "current_event",
            wait_event_type AS "wait_class"
          FROM pg_stat_activity s
          WHERE state IS NOT NULL
          ORDER BY COALESCE(query_start, backend_start)
          LIMIT 10
        singleRow: false
      top_sql_by_elapsed:
        description: Top SQL by elapsed time
        sql: |
          SELECT 
            NULL::text AS "id", 
            NULL::bigint AS "calls", 
            NULL::numeric AS "elapsedMs", 
            NULL::numeric AS "cpuMs", 
            NULL::bigint AS "rows", 
            NULL::numeric AS "ioReadMB", 
            NULL::numeric AS "ioWriteMB", 
            'pg_stat_statements not installed' AS "warning"
          FROM pg_available_extensions
          WHERE name = 'pg_stat_statements' AND installed_version IS NULL
        singleRow: false
      top_sql_by_io:
        description: Top SQL by physical I/O operations
        sql: |
          SELECT 
            NULL::text AS "id",
            NULL::text AS "sql_text",
            NULL::bigint AS "execs",
            NULL::bigint AS "phys_reads",
            NULL::numeric AS "reads_per_exec",
            NULL::numeric AS "read_mb",
            'pg_stat_statements not installed' AS "warning"
          FROM pg_available_extensions
          WHERE name = 'pg_stat_statements' AND installed_version IS NULL
        singleRow: false
      frequent_parse_sql:
        description: SQL with high parse frequency
        sql: |
          SELECT 
            NULL::text AS "id",
            NULL::text AS "sql_text",
            NULL::bigint AS "parse_count",
            NULL::bigint AS "exec_count",
            NULL::numeric AS "parse_overhead_pct",
            'pg_stat_statements not installed' AS "warning"
          FROM pg_available_extensions
          WHERE name = 'pg_stat_statements' AND installed_version IS NULL
        singleRow: false
      inefficient_sql:
        description: SQL with high parse ratio
        sql: |
          SELECT 
            NULL::text AS "id",
            NULL::text AS "sql_text",
            NULL::bigint AS "calls",
            NULL::bigint AS "rows",
            NULL::numeric AS "rows_per_exec",
            'pg_stat_statements not installed' AS "warning"
          FROM pg_available_extensions
          WHERE name = 'pg_stat_statements' AND installed_version IS NULL
        singleRow: false
      redo_log_info:
        description: Redo log groups and archival status
        sql: |
          SELECT 
            pg_size_bytes(current_setting('wal_segment_size')) / 1024 / 1024 AS "size_mb",
            CASE WHEN pg_is_in_recovery() THEN 'recovery' ELSE 'primary' END AS "status"
        singleRow: true
      database_file_growth:
        description: Database file allocation and growth metrics
        sql: |
          SELECT 
            ROUND(SUM(pg_tablespace_size(oid))::numeric / 1024 / 1024 / 1024, 2) "total_allocated_gb",
            COUNT(*) "file_count",
            NULL::numeric AS "avg_file_size_mb",
            NULL::numeric AS "max_file_size_mb",
            NULL::numeric AS "min_file_size_mb"
          FROM pg_tablespace
        singleRow: true
      critical_parameters:
        description: Key database configuration parameters
        sql: |
          SELECT 
            name AS "parameter",
            vartype AS "type",
            setting AS "current_value",
            boot_val AS "default_value",
            CASE WHEN source = 'default' THEN 'Yes' ELSE 'No' END AS "is_default"
          FROM pg_settings
          WHERE name IN ('shared_buffers', 'work_mem', 'max_connections', 'max_wal_size', 'max_worker_processes', 'track_activity_query_size')
          ORDER BY name
        singleRow: false
